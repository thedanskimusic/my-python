"""
Vulnerability scanning module
Scans code for common security vulnerabilities and bad practices
"""

from typing import List, Dict
import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..'))
from src.scanner.file_scanner import FileScanner
from src.patterns.rules import VULNERABILITY_PATTERNS


class VulnerabilityScanner:
    """Detects security vulnerabilities in code"""
    
    def __init__(self):
        self.file_scanner = FileScanner()
        self.patterns = VULNERABILITY_PATTERNS
    
    def scan_file(self, file_path: str) -> List[Dict]:
        """
        Scan a single file for vulnerabilities
        
        Args:
            file_path: Path to the file to scan
            
        Returns:
            List of findings with line numbers and context
        """
        findings = []
        
        # Only scan code files for vulnerabilities
        if not self.file_scanner.is_code_file(file_path):
            return findings
        
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                lines = f.readlines()
                
            for line_num, line in enumerate(lines, start=1):
                # Skip comments for some patterns
                stripped_line = line.strip()
                if stripped_line.startswith('#'):
                    continue
                
                for pattern_info in self.patterns:
                    pattern = pattern_info['pattern']
                    matches = pattern.finditer(line)
                    
                    for match in matches:
                        # Get context (surrounding lines)
                        context_start = max(0, line_num - 2)
                        context_end = min(len(lines), line_num + 1)
                        context = ''.join(lines[context_start:context_end])
                        
                        finding = {
                            'type': 'vulnerability',
                            'name': pattern_info['name'],
                            'severity': pattern_info['severity'],
                            'description': pattern_info['description'],
                            'file': file_path,
                            'line': line_num,
                            'match': match.group(0)[:50] + '...' if len(match.group(0)) > 50 else match.group(0),
                            'context': context.strip()
                        }
                        findings.append(finding)
                        
        except Exception as e:
            # Skip files that can't be read
            pass
            
        return findings
    
    def scan_directory(self, directory: str, recursive: bool = True) -> List[Dict]:
        """
        Scan a directory for vulnerabilities
        
        Args:
            directory: Directory path to scan
            recursive: Whether to scan subdirectories
            
        Returns:
            List of all findings
        """
        all_findings = []
        files = self.file_scanner.get_code_files(directory, recursive)
        
        for file_path in files:
            findings = self.scan_file(file_path)
            all_findings.extend(findings)
            
        return all_findings

